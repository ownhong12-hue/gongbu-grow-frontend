<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µë¶€ íƒ€ì´ë¨¸ - ê³µë¶€.ì„±ì¥</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --bg-light: #1e293b;
            --bg-lighter: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        /* í—¤ë” */
        .header {
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        /* íƒ€ì´ë¨¸ */
        .timer-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* ì˜¤ëŠ˜ ì´ ì‹œê°„ (ë§¨ ìœ„) */
        .today-total-banner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .today-total-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .today-total-time {
            font-size: 2rem;
            font-weight: 900;
        }
        
        .timer-display {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-lighter));
            border: 2px solid var(--border);
            border-radius: 30px;
            padding: 60px 40px 30px 40px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .timer-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .timer-display.active::before {
            animation: pulse 2s ease-in-out infinite;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.15) 0%, transparent 70%);
        }
        
        .subject-label {
            position: relative;
            z-index: 1;
            display: inline-block;
            padding: 8px 20px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 30px;
        }
        
        .time-display {
            position: relative;
            z-index: 1;
            font-family: 'Black Han Sans', sans-serif;
            font-size: 5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            letter-spacing: 4px;
        }
        
        .timer-display.active .time-display {
            background: linear-gradient(135deg, var(--success), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ê¸°ë¡ ë©”ì‹œì§€ ì˜ì—­ (íƒ€ì´ë¨¸ ì•„ë˜) */
        .record-messages {
            position: relative;
            z-index: 1;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .record-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--success);
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .session-info {
            position: relative;
            z-index: 1;
            font-size: 1.1rem;
            color: var(--text-muted);
        }
        
        /* ì»¨íŠ¸ë¡¤ */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        .btn-start {
            background: linear-gradient(135deg, var(--success), var(--primary));
            color: white;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }
        
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, var(--danger), var(--warning));
            color: white;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }
        
        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4);
        }
        
        .btn-reset {
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        .btn-reset:hover {
            border-color: var(--primary);
        }
        
        /* ê³¼ëª© ì„ íƒ */
        .subject-selector {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .selector-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .subject-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .subject-chip {
            padding: 10px 20px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .subject-chip:hover {
            border-color: var(--primary);
        }
        
        .subject-chip.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            color: white;
        }
        
        /* ì˜¤ëŠ˜ì˜ ê¸°ë¡ */
        .today-sessions {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
        }
        
        .today-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .today-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .session-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .session-subject {
            display: inline-block;
            padding: 4px 12px;
            background: var(--bg-lighter);
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .session-time {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .session-duration {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        @media (max-width: 600px) {
            .time-display {
                font-size: 3.5rem;
            }
            
            .timer-display {
                padding: 40px 20px 20px 20px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div style="display: flex; gap: 10px;">
            <button class="back-btn" onclick="window.location.href='dashboard.html'">â†</button>
            <button class="back-btn" onclick="window.location.href='index.html'" title="ì²˜ìŒìœ¼ë¡œ">ğŸ </button>
        </div>
        <h1 class="header-title">â±ï¸ ê³µë¶€ íƒ€ì´ë¨¸</h1>
    </header>
    
    <div class="timer-container">
        <!-- ì˜¤ëŠ˜ ì´ ì‹œê°„ (ë§¨ ìœ„) -->
        <div class="today-total-banner">
            <div class="today-total-label">ğŸ“Š ì˜¤ëŠ˜ ì´ ê³µë¶€ ì‹œê°„</div>
            <div class="today-total-time" id="todayTotalBanner">0ë¶„</div>
        </div>
        
        <!-- íƒ€ì´ë¨¸ -->
        <div class="timer-display" id="timerDisplay">
            <div class="subject-label" id="currentSubjectLabel">ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="time-display" id="timeDisplay">00:00:00</div>
            
            <!-- ê¸°ë¡ ë©”ì‹œì§€ (íƒ€ì´ë¨¸ ì•„ë˜) -->
            <div class="record-messages" id="recordMessages"></div>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="controls">
            <button class="btn btn-start" id="startBtn" onclick="startTimer()">
                â–¶ï¸ ì‹œì‘
            </button>
            <button class="btn btn-stop" id="stopBtn" onclick="stopTimer()" style="display: none;">
                â¸ï¸ ì •ì§€
            </button>
            <button class="btn btn-reset" id="resetBtn" onclick="resetTimer()">
                ğŸ”„ ë¦¬ì…‹
            </button>
        </div>
        
        <!-- ê³¼ëª© ì„ íƒ -->
        <div class="subject-selector">
            <div class="selector-title">ğŸ“š ê³¼ëª© ì„ íƒ</div>
            <div class="subject-chips">
                <div class="subject-chip" data-subject="êµ­ì–´" onclick="selectSubject(this)">êµ­ì–´</div>
                <div class="subject-chip" data-subject="ì˜ì–´" onclick="selectSubject(this)">ì˜ì–´</div>
                <div class="subject-chip" data-subject="ìˆ˜í•™" onclick="selectSubject(this)">ìˆ˜í•™</div>
                <div class="subject-chip" data-subject="ê³¼í•™" onclick="selectSubject(this)">ê³¼í•™</div>
                <div class="subject-chip" data-subject="ì‚¬íšŒ" onclick="selectSubject(this)">ì‚¬íšŒ</div>
                <div class="subject-chip" data-subject="ê¸°íƒ€" onclick="selectSubject(this)">ê¸°íƒ€</div>
            </div>
        </div>
        
        <!-- ì˜¤ëŠ˜ì˜ ê¸°ë¡ -->
        <div class="today-sessions">
            <div class="today-header">
                <div class="today-title">ğŸ“… ì˜¤ëŠ˜ì˜ ìƒì„¸ ê¸°ë¡</div>
            </div>
            <div class="session-list" id="sessionList">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                    ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let timerInterval = null;
        let seconds = 0;
        let currentSubject = null;
        let startTime = null;
        
        // ê³¼ëª© ì„ íƒ
        function selectSubject(element) {
            document.querySelectorAll('.subject-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            element.classList.add('active');
            currentSubject = element.dataset.subject;
            document.getElementById('currentSubjectLabel').textContent = currentSubject;
        }
        
        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            if (!currentSubject) {
                alert('ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (timerInterval) return;
            
            startTime = Date.now() - (seconds * 1000);
            
            timerInterval = setInterval(() => {
                seconds = Math.floor((Date.now() - startTime) / 1000);
                updateDisplay();
            }, 1000);
            
            document.getElementById('timerDisplay').classList.add('active');
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
        }
        
        // íƒ€ì´ë¨¸ ì •ì§€ (ê°œì„  ë²„ì „)
        function stopTimer() {
            if (!timerInterval) return;
            
            clearInterval(timerInterval);
            timerInterval = null;
            
            // ì„¸ì…˜ ì €ì¥ (0ì´ˆ ì´ìƒì¼ ë•Œë§Œ)
            if (seconds > 0) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                // ê¸°ë¡ ë©”ì‹œì§€ ì¶”ê°€
                const messagesContainer = document.getElementById('recordMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'record-message';
                
                let timeText = '';
                if (hours > 0) {
                    timeText = `${hours}ì‹œê°„ ${minutes}ë¶„`;
                } else if (minutes > 0) {
                    timeText = `${minutes}ë¶„`;
                } else {
                    timeText = `${seconds}ì´ˆ`;
                }
                
                messageDiv.textContent = `âœ… ${timeText}ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`;
                messagesContainer.insertBefore(messageDiv, messagesContainer.firstChild);
                
                // ì„¸ì…˜ ì €ì¥
                saveSession();
                
                // íƒ€ì´ë¨¸ ë¦¬ì…‹
                seconds = 0;
                updateDisplay();
            }
            
            document.getElementById('timerDisplay').classList.remove('active');
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
        }
        
        // íƒ€ì´ë¨¸ ë¦¬ì…‹
        function resetTimer() {
            if (timerInterval) {
                if (confirm('ì§„í–‰ ì¤‘ì¸ íƒ€ì´ë¨¸ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    document.getElementById('timerDisplay').classList.remove('active');
                    document.getElementById('startBtn').style.display = 'block';
                    document.getElementById('stopBtn').style.display = 'none';
                } else {
                    return;
                }
            }
            
            seconds = 0;
            updateDisplay();
        }
        
        // ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        function updateDisplay() {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            const timeString = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(secs).padStart(2, '0');
            
            document.getElementById('timeDisplay').textContent = timeString;
        }
        
        // ì„¸ì…˜ ì €ì¥
        async function saveSession() {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            const session = {
                subject: currentSubject,
                duration: seconds,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            // LocalStorageì— ì €ì¥
            const logs = JSON.parse(localStorage.getItem('gongbu_study_logs') || '[]');
            logs.push(session);
            localStorage.setItem('gongbu_study_logs', JSON.stringify(logs));
            
            // Backend APIë¡œ ì „ì†¡
            try {
                await api.addStudyLog({
                    subject: currentSubject,
                    hours: hours,
                    minutes: minutes,
                    date: new Date().toISOString().split('T')[0]
                });
                console.log('âœ… Backendì— í•™ìŠµ ê¸°ë¡ ì €ì¥ ì™„ë£Œ!');
            } catch (error) {
                console.error('âŒ Backend ì €ì¥ ì‹¤íŒ¨:', error);
            }
            
            // í¬ì¸íŠ¸ ì¶”ê°€
            const points = Math.floor(seconds / 360);
            const user = JSON.parse(localStorage.getItem('gongbu_user') || '{}');
            user.points = (user.points || 0) + points;
            localStorage.setItem('gongbu_user', JSON.stringify(user));
            
            // í™”ë©´ ê°±ì‹ 
            loadTodaySessions();
            updateTodayTotal();
        }
        
        // ì˜¤ëŠ˜ ì´ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateTodayTotal() {
            const logs = JSON.parse(localStorage.getItem('gongbu_study_logs') || '[]');
            const today = new Date().toDateString();
            
            const todaySessions = logs.filter(log => {
                const logDate = new Date(log.date).toDateString();
                return logDate === today;
            });
            
            const totalSeconds = todaySessions.reduce((sum, session) => sum + session.duration, 0);
            const totalMinutes = Math.floor(totalSeconds / 60);
            const totalHours = Math.floor(totalMinutes / 60);
            
            let displayText;
            if (totalHours > 0) {
                displayText = `${totalHours}ì‹œê°„ ${totalMinutes % 60}ë¶„`;
            } else if (totalMinutes > 0) {
                displayText = `${totalMinutes}ë¶„`;
            } else {
                displayText = '0ë¶„';
            }
            
            document.getElementById('todayTotalBanner').textContent = displayText;
        }
        
        // ì˜¤ëŠ˜ì˜ ì„¸ì…˜ ë¡œë“œ
        function loadTodaySessions() {
            const logs = JSON.parse(localStorage.getItem('gongbu_study_logs') || '[]');
            const today = new Date().toDateString();
            
            const todaySessions = logs.filter(log => {
                const logDate = new Date(log.date).toDateString();
                return logDate === today;
            });
            
            const listContainer = document.getElementById('sessionList');
            
            if (todaySessions.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                        ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = todaySessions.reverse().map(session => {
                const hours = Math.floor(session.duration / 3600);
                const minutes = Math.floor((session.duration % 3600) / 60);
                const time = new Date(session.date).toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let durationText;
                if (hours > 0) {
                    durationText = `${hours}ì‹œê°„ ${minutes}ë¶„`;
                } else {
                    durationText = `${minutes}ë¶„`;
                }
                
                return `
                    <div class="session-item">
                        <div>
                            <div class="session-subject">${session.subject}</div>
                            <div class="session-time">${time}</div>
                        </div>
                        <div class="session-duration">${durationText}</div>
                    </div>
                `;
            }).join('');
        }
        
        // í˜ì´ì§€ ë– ë‚  ë•Œ ì²˜ë¦¬
        window.addEventListener('beforeunload', (e) => {
            // íƒ€ì´ë¨¸ ì§„í–‰ ì¤‘ì´ë©´
            if (timerInterval && seconds > 0) {
                // ê²½ê³ ì°½
                e.preventDefault();
                e.returnValue = 'íƒ€ì´ë¨¸ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜„ì¬ê¹Œì§€ì˜ ì‹œê°„ì´ ìë™ ì €ì¥ë©ë‹ˆë‹¤.';
                
                // ìë™ ì €ì¥ (ë™ê¸°ì‹)
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                // LocalStorageì— ì €ì¥
                const session = {
                    subject: currentSubject,
                    duration: seconds,
                    date: new Date().toISOString(),
                    timestamp: Date.now()
                };
                
                const logs = JSON.parse(localStorage.getItem('gongbu_study_logs') || '[]');
                logs.push(session);
                localStorage.setItem('gongbu_study_logs', JSON.stringify(logs));
                
                // Backend ì „ì†¡ (sendBeacon ì‚¬ìš© - í˜ì´ì§€ ë‹«í˜€ë„ ì „ì†¡ë¨)
                const token = localStorage.getItem('gongbu_token');
                if (token) {
                    const apiUrl = 'https://gongbu-grow-backend-production.up.railway.app/api/study-logs';
                    const data = {
                        subject: currentSubject,
                        hours: hours,
                        minutes: minutes,
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    // sendBeaconì€ í˜ì´ì§€ê°€ ë‹«í˜€ë„ ìš”ì²­ì„ ë³´ëƒ„
                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    navigator.sendBeacon(apiUrl, blob);
                }
                
                return e.returnValue;
            }
        });
        
        // í™”ë©´ êº¼ì§ˆ ë•Œ ìë™ ì €ì¥ (ëª¨ë°”ì¼)
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden && timerInterval && seconds > 0) {
                // í™”ë©´ì´ êº¼ì§€ë©´ ìë™ ì €ì¥
                clearInterval(timerInterval);
                timerInterval = null;
                
                await saveSession();
                
                // íƒ€ì´ë¨¸ ë¦¬ì…‹
                seconds = 0;
                updateDisplay();
                
                document.getElementById('timerDisplay').classList.remove('active');
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
            }
        });
        
        // ì´ˆê¸° ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadTodaySessions();
            updateTodayTotal();
        });
    </script>
</body>
</html>
